<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pro - Nagore & Jose</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 p-4 md:p-8">
<div class="max-w-4xl mx-auto">
    <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl font-black text-slate-800 italic tracking-tight">Nagore & Jose 游늵</h1>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Panel de Control</p>
        </div>
        <div class="flex gap-2 w-full md:w-auto">
            <button onclick="fetchGoogleData()" class="flex-1 md:flex-none bg-white border border-slate-200 text-slate-700 px-4 py-3 rounded-2xl hover:bg-slate-100 transition text-sm font-bold shadow-sm">游댃 Actualizar</button>
            <button onclick="downloadPDF()" class="flex-1 md:flex-none bg-emerald-600 text-white px-4 py-3 rounded-2xl hover:bg-emerald-700 transition text-sm font-bold shadow-md">游늯 PDF Boda</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 text-center">
            <span class="text-slate-400 block uppercase text-[10px] font-bold tracking-widest mb-1">Confirmados</span>
            <span id="total-invitados" class="text-5xl font-black text-amber-700">-</span>
        </div>
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 text-center border-b-4 border-blue-500">
            <span class="text-slate-400 block uppercase text-[10px] font-bold tracking-widest mb-1">Plazas Bus</span>
            <span id="total-bus" class="text-5xl font-black text-blue-600">-</span>
        </div>
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 text-center border-b-4 border-emerald-500">
            <span class="text-slate-400 block uppercase text-[10px] font-bold tracking-widest mb-1">Preboda</span>
            <span id="total-preboda" class="text-5xl font-black text-emerald-600">-</span>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <h2 class="text-lg font-black mb-4 text-slate-700 flex items-center gap-2 border-b pb-2 italic">游볹 Dietas Especiales</h2>
            <div id="dietas-list" class="space-y-2"></div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
            <h2 class="text-lg font-black mb-4 text-blue-700 flex items-center gap-2 border-b pb-2 italic">游꽂 Barra Libre</h2>
            <div id="bebidas-list" class="max-h-80 overflow-y-auto space-y-2 pr-2"></div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
        <h2 class="text-lg font-black mb-4 text-purple-700 flex items-center gap-2 border-b pb-2 italic">游꿧 Peticiones al DJ</h2>
        <div id="canciones-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>
</div>

<script>
    // URL DE TU GOOGLE SHEETS
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSGhu1UBnlj04JEJk4Ok0JeYRMSS4mcOHS0X-RZChVHaZGGFWAMDDhoAofqm3ZJ1efeLLUDifRXzogi/pub?output=csv';
    let currentData = [];

    function fetchGoogleData() {
        Papa.parse(GOOGLE_SHEET_CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                // Filtramos filas vac칤as
                currentData = results.data.filter(s => s.nombre && s.nombre.trim() !== "");
                renderDashboard(currentData);
            }
        });
    }

    function renderDashboard(subs) {
        // Totales
        document.getElementById('total-invitados').innerText = subs.length;
        document.getElementById('total-bus').innerText = subs.filter(s => s.autobus && s.autobus.toLowerCase() === 'si').length;
        document.getElementById('total-preboda').innerText = subs.filter(s => s.preboda && s.preboda.toLowerCase() === 'si').length;

        // Dietas: Recuento autom치tico
        const dietas = {};
        subs.forEach(s => {
            if (s.dieta) {
                s.dieta.split(',').forEach(d => {
                    const val = d.trim();
                    if(val && val !== "-") dietas[val] = (dietas[val] || 0) + 1;
                });
            }
        });

        document.getElementById('dietas-list').innerHTML = Object.entries(dietas).map(([k, v]) => `
            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100">
                <span class="text-slate-700 font-bold text-sm">${k}</span>
                <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-xs font-black">${v}</span>
            </div>
        `).join('') || '<p class="text-slate-400 text-sm italic text-center">Sin dietas registradas</p>';

        // Bebidas: Lista separada por invitado
        document.getElementById('bebidas-list').innerHTML = subs.map(s =>
            s.bebida ? `
            <div class="p-3 bg-blue-50/50 rounded-2xl border-l-4 border-blue-400 shadow-sm text-xs">
                <b class="text-blue-900 uppercase text-[9px] block mb-1">${s.nombre}</b>
                <span class="text-slate-700 font-medium">${s.bebida}</span>
            </div>` : ''
        ).join('') || '<p class="text-slate-400 text-sm italic text-center">No hay datos de bebidas</p>';

        // Canciones: Con bot칩n t치ctil para Spotify
        document.getElementById('canciones-list').innerHTML = subs.map(s =>
            s.cancion ? `
            <div class="flex justify-between items-center p-4 bg-purple-50/50 rounded-2xl border border-purple-100 shadow-sm">
                <div class="flex flex-col">
                    <span class="text-[9px] text-purple-400 uppercase font-black tracking-tighter">${s.nombre} pide:</span>
                    <span class="text-sm font-bold text-slate-800 leading-tight">${s.cancion}</span>
                </div>
                <a href="https://open.spotify.com/search/${encodeURIComponent(s.cancion)}" target="_blank"
                   class="bg-[#1DB954] text-white p-3 rounded-full hover:scale-110 active:scale-95 transition shadow-lg"
                   title="Buscar en Spotify">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm5.508 17.302c-.223.367-.704.484-1.071.261-2.974-1.819-6.717-2.228-11.127-1.221-.419.096-.84-.17-.936-.589-.096-.419.17-.84.589-.936 4.828-1.104 8.956-.636 12.284 1.404.367.223.484.704.261 1.071zm1.474-3.264c-.281.456-.88.604-1.336.323-3.405-2.094-8.595-2.703-12.62-1.478-.513.156-1.054-.134-1.21-.647-.156-.513.134-1.054.647-1.21 4.595-1.396 10.327-.72 14.259 1.699.456.281.604.88.323 1.336zm.139-3.413C15.222 8.251 8.8 8.038 5.071 9.17c-.621.189-1.272-.164-1.461-.785-.189-.621.164-1.272.785-1.461 4.275-1.299 11.365-1.042 15.823 1.604.559.332.744 1.053.412 1.612-.332.559-1.053.744-1.612.412z"/></svg>
                </a>
            </div>` : ''
        ).join('') || '<p class="text-slate-400 text-sm italic text-center">A칰n no han pedido canciones</p>';
    }

    // PDF: Mantenido con el formato que le gusta al catering
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');

        doc.setFontSize(22);
        doc.setTextColor(30, 41, 59); // Slate-800
        doc.text("LISTA MAESTRA - BODA NAGORE & JOSE", 14, 20);

        const tableData = currentData.map(s => [
            s.nombre,
            s.invitados || '1',
            s.autobus && s.autobus.toLowerCase() === 'si' ? 'BUS' : 'NO',
            s.dieta || '-',
            s.dieta_detalles || '-',
            s.bebida || '-'
        ]);

        doc.autoTable({
            startY: 30,
            head: [['Nombre Invitado', 'Cant.', 'Bus', 'Dieta', 'Observaciones Dieta', 'Bebida']],
            body: tableData,
            theme: 'grid',
            headStyles: { fillColor: [180, 150, 100], textColor: [255, 255, 255], fontStyle: 'bold' },
            styles: { fontSize: 8, cellPadding: 3 },
            columnStyles: {
                4: { cellWidth: 50 } // M치s espacio para las observaciones de dieta
            }
        });

        doc.save("Boda_Nagore_Jose_Lista_Completa.pdf");
    }

    // Inicializar carga de datos
    fetchGoogleData();
</script>
</body>
</html>